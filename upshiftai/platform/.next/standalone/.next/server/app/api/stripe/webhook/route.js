"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},18486:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>m,requestAsyncStorage:()=>f,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{POST:()=>l});var i=r(49303),o=r(88716),n=r(60670),a=r(87070),u=r(39256),c=r(53673);let p=null;async function l(e){let t;let r=(!p&&process.env.STRIPE_SECRET_KEY&&(p=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-09-30.acacia"})),p);if(!r)return a.NextResponse.json({error:"Stripe not configured"},{status:500});let s=await e.text(),i=e.headers.get("stripe-signature"),o=process.env.STRIPE_WEBHOOK_SECRET;if(!o)return a.NextResponse.json({error:"Webhook secret not set"},{status:500});try{t=r.webhooks.constructEvent(s,i,o)}catch(e){return a.NextResponse.json({error:e.message},{status:400})}if("checkout.session.completed"===t.type){let e=t.data.object,r=e.client_reference_id,s=e.subscription,i="string"==typeof s?s:s?.id,o=e.customer;r&&(i||o)&&(0,c.fs)(r,{customerId:o||"",subscriptionId:i||"",status:"active"})}if("customer.subscription.updated"===t.type){let e=t.data.object,r="active"===e.status?"active":e.status;(0,c.lY)(e.id,r)}if("customer.subscription.deleted"===t.type){let e=t.data.object;(0,c.lY)(e.id,"cancelled")}return a.NextResponse.json({received:!0})}let d=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/jeffadkins/upshift/upshiftai/platform/app/api/stripe/webhook/route.js",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:_,serverHooks:g}=d,b="/api/stripe/webhook/route";function m(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},53673:(e,t,r)=>{r.d(t,{Qd:()=>u,b9:()=>a,bM:()=>_,fF:()=>f,fL:()=>c,fs:()=>p,lG:()=>d,lY:()=>l});var s=r(37857);let i="https://rbfzlqmkwhbvrrfdcain.supabase.co",o=process.env.SUPABASE_SERVICE_ROLE_KEY,n=i&&o?(0,s.eI)(i,o):null;async function a(e){if(!n)return[];let{data:t,error:r}=await n.from("reports").select("*").eq("user_id",e).order("created_at",{ascending:!1});return r?(console.error("Error fetching reports:",r),[]):t||[]}async function u(e){if(!n)return null;let t=`usk_${Date.now()}_${Math.random().toString(36).slice(2,24)}`,{error:r}=await n.from("api_keys").insert([{api_key_value:t,user_id:e}]);return r?(console.error("Error creating API key:",r),null):t}async function c(e){if(!n)return null;let{data:t}=await n.from("api_keys").select("user_id").eq("api_key_value",e).single();return t?.user_id??null}async function p(e,{customerId:t,subscriptionId:r,status:s,planTier:i}){if(!n||!e)return;let{error:o}=await n.from("subscriptions").upsert({user_id:e,customer_id:t,subscription_id:r,status:s,plan_tier:i||"pro",updated_at:new Date().toISOString()},{onConflict:"user_id"});o&&console.error("Error setting subscription:",o)}async function l(e,t){if(!n)return;let{data:r}=await n.from("subscriptions").select("user_id").eq("subscription_id",e).single();if(!r)return;let{error:s}=await n.from("subscriptions").update({status:t,updated_at:new Date().toISOString()}).eq("subscription_id",e);s&&console.error("Error updating subscription status:",s)}async function d(e){if(!n)return!1;let{data:t}=await n.from("subscriptions").select("status").eq("user_id",e).single();return t?.status==="active"||t?.status==="trialing"}async function f(e,t){n&&await n.from("ai_usage").insert({user_id:e,feature:t,created_at:new Date().toISOString()})}async function _(e){if(!n)return 0;let t=new Date;t.setDate(1),t.setHours(0,0,0,0);let{count:r,error:s}=await n.from("ai_usage").select("*",{count:"exact",head:!0}).eq("user_id",e).gte("created_at",t.toISOString());return s?(console.error("Error counting usage:",s),0):r||0}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,857,972,256],()=>r(18486));module.exports=s})();