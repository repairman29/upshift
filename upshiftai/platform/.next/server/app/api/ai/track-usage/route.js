"use strict";(()=>{var e={};e.id=447,e.ids=[447],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},37750:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>_,patchFetch:()=>m,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{POST:()=>p});var a=t(49303),n=t(88716),i=t(60670),o=t(87070),u=t(53673);let c={free:10,pro:1e3,team:1e4};async function p(e){try{let{feature:r,apiKey:t}=await e.json();if(!t)return o.NextResponse.json({error:"API key required"},{status:401});let s=await (0,u.fL)(t);if(!s)return o.NextResponse.json({error:"Invalid API key"},{status:401});let a=await (0,u.lG)(s)?"pro":"free",n=c[a],i=await (0,u.bM)(s);if(i>=n)return o.NextResponse.json({error:"AI quota exceeded",message:`${i}/${n} queries used. Upgrade for more.`,tier:a,limit:n},{status:429});return await (0,u.fF)(s,r),o.NextResponse.json({success:!0,remaining:n-(i+1),tier:a,limit:n})}catch(e){return console.error("AI usage tracking error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/ai/track-usage/route",pathname:"/api/ai/track-usage",filename:"route",bundlePath:"app/api/ai/track-usage/route"},resolvedPagePath:"/Users/jeffadkins/upshift/upshiftai/platform/app/api/ai/track-usage/route.js",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:f,serverHooks:g}=l,_="/api/ai/track-usage/route";function m(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},53673:(e,r,t)=>{t.d(r,{Qd:()=>u,b9:()=>o,bM:()=>g,fF:()=>f,fL:()=>c,fs:()=>p,lG:()=>d,lY:()=>l});var s=t(37857);let a="https://rbfzlqmkwhbvrrfdcain.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY,i=a&&n?(0,s.eI)(a,n):null;async function o(e){if(!i)return[];let{data:r,error:t}=await i.from("reports").select("*").eq("user_id",e).order("created_at",{ascending:!1});return t?(console.error("Error fetching reports:",t),[]):r||[]}async function u(e){if(!i)return null;let r=`usk_${Date.now()}_${Math.random().toString(36).slice(2,24)}`,{error:t}=await i.from("api_keys").insert([{api_key_value:r,user_id:e}]);return t?(console.error("Error creating API key:",t),null):r}async function c(e){if(!i)return null;let{data:r}=await i.from("api_keys").select("user_id").eq("api_key_value",e).single();return r?.user_id??null}async function p(e,{customerId:r,subscriptionId:t,status:s,planTier:a}){if(!i||!e)return;let{error:n}=await i.from("subscriptions").upsert({user_id:e,customer_id:r,subscription_id:t,status:s,plan_tier:a||"pro",updated_at:new Date().toISOString()},{onConflict:"user_id"});n&&console.error("Error setting subscription:",n)}async function l(e,r){if(!i)return;let{data:t}=await i.from("subscriptions").select("user_id").eq("subscription_id",e).single();if(!t)return;let{error:s}=await i.from("subscriptions").update({status:r,updated_at:new Date().toISOString()}).eq("subscription_id",e);s&&console.error("Error updating subscription status:",s)}async function d(e){if(!i)return!1;let{data:r}=await i.from("subscriptions").select("status").eq("user_id",e).single();return r?.status==="active"||r?.status==="trialing"}async function f(e,r){i&&await i.from("ai_usage").insert({user_id:e,feature:r,created_at:new Date().toISOString()})}async function g(e){if(!i)return 0;let r=new Date;r.setDate(1),r.setHours(0,0,0,0);let{count:t,error:s}=await i.from("ai_usage").select("*",{count:"exact",head:!0}).eq("user_id",e).gte("created_at",r.toISOString());return s?(console.error("Error counting usage:",s),0):t||0}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,857,972],()=>t(37750));module.exports=s})();