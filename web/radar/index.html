<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radar – Central view of dependency health across all your repos | Upshift</title>
  <meta name="description" content="See every repo’s dependency health in one place. Outdated counts, vulnerabilities, ecosystems. Free: paste reports. Pro: persisted dashboard, history, alerts." />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    .radar-page { --radar-max: 960px; }
    .radar-hero { padding: 4rem 0 3rem; text-align: center; }
    .radar-hero h1 { font-size: clamp(1.75rem, 4vw, 2.25rem); margin-bottom: 0.5rem; }
    .radar-hero .tag { font-family: var(--font-mono); font-size: 0.9rem; color: var(--accent); margin-bottom: 0.5rem; }
    .radar-hero .lead { color: var(--text-muted); max-width: 540px; margin: 0 auto 1.5rem; }
    .radar-tiers { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; max-width: var(--radar-max); margin: 0 auto 2rem; padding: 0 1.5rem; }
    @media (max-width: 640px) { .radar-tiers { grid-template-columns: 1fr; } }
    .radar-tier { background: var(--bg-soft); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
    .radar-tier.pro { border-color: var(--accent); }
    .radar-tier h3 { margin: 0 0 0.5rem; font-size: 1.1rem; }
    .radar-tier .badge { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
    .radar-tier ul { margin: 0.5rem 0 0; padding-left: 1.25rem; color: var(--text-muted); font-size: 0.9rem; }
    .radar-tier li { margin-bottom: 0.25rem; }
    .radar-dashboard { max-width: var(--radar-max); margin: 0 auto 2rem; padding: 0 1.5rem; }
    .radar-dashboard h2 { font-size: 1.25rem; margin-bottom: 1rem; }
    .radar-dashboard .card-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .radar-card { background: var(--bg-soft); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem 1.25rem; min-width: 120px; }
    .radar-card .value { font-size: 1.5rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .radar-card .label { font-size: 0.85rem; color: var(--text-muted); }
    .radar-actions { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .radar-actions button { padding: 0.5rem 1rem; background: var(--bg-soft); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .radar-actions button:hover { border-color: var(--accent); color: var(--accent); }
    .radar-actions button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .radar-actions button.primary:hover { background: var(--accent-hover); }
    .radar-actions input[type="file"] { display: none; }
    .radar textarea { width: 100%; min-height: 100px; font-family: var(--font-mono); font-size: 12px; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text); resize: vertical; }
    .radar .hint { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }
    .radar table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .radar th, .radar td { text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); }
    .radar th { font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
    .radar td.repo { font-weight: 500; }
    .radar td.count { font-variant-numeric: tabular-nums; }
    .radar .empty { color: var(--text-muted); padding: 2rem; text-align: center; }
    .radar .cta-pro { text-align: center; padding: 2rem; background: var(--bg-soft); border-radius: var(--radius); margin-top: 2rem; }
    .radar .cta-pro a { color: var(--accent); font-weight: 600; }
    .radar-pro-section { max-width: var(--radar-max); margin: 0 auto 2rem; padding: 0 1.5rem; }
    .radar-pro-section h2 { font-size: 1.25rem; margin-bottom: 1rem; }
    .radar-pro-list { margin-top: 1rem; }
    .radar-pro-list table { width: 100%; }
    .radar-pro-list .pro-open { padding: 0.35rem 0.75rem; font-size: 0.85rem; background: var(--accent); border: none; border-radius: var(--radius-sm); color: #fff; cursor: pointer; }
    .radar-pro-list .pro-open:hover { background: var(--accent-hover); }
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap">
      <a href="/" class="logo">upshift</a>
      <nav>
        <a href="/#demo">Demo</a>
        <a href="/radar/">Radar</a>
        <a href="/#compare">vs Dependabot</a>
        <a href="/#pricing">Pricing</a>
        <a href="https://github.com/repairman29/upshift/tree/main/docs" target="_blank" rel="noopener">Docs</a>
        <a href="/blog/index.html">Blog</a>
        <a href="https://github.com/repairman29/upshift" class="nav-gh" target="_blank" rel="noopener">GitHub</a>
      </nav>
    </div>
  </header>

  <main class="radar-page">
    <section class="radar-hero">
      <div class="wrap-wide">
        <p class="tag">Central dependency view</p>
        <h1>Radar</h1>
        <p class="lead">See every repo’s dependency health in one place. Outdated counts, vulnerabilities, ecosystems. One dashboard for your whole stack.</p>
        <p class="hint">Generate reports with <code>upshift scan --report report.json</code> in each repo, then paste or upload below. Or use <code>upshift radar</code> to open this page.</p>
      </div>
    </section>

    <section class="radar-tiers">
      <div class="radar-tier">
        <h3>Radar Free</h3>
        <span class="badge">Try it now</span>
        <ul>
          <li>Paste or upload scan reports in-browser</li>
          <li>Summary table: repos, outdated, vulns</li>
          <li>No account required</li>
          <li>Data stays in your session</li>
        </ul>
      </div>
      <div class="radar-tier pro">
        <h3>Radar Pro</h3>
        <span class="badge">Revenue · Pro / Team</span>
        <ul>
          <li>Persisted dashboard and report history</li>
          <li>Upload from CLI or CI (<code>--upload</code>)</li>
          <li>Alerts when thresholds are exceeded</li>
          <li>Export and org-wide visibility</li>
        </ul>
        <p style="margin-top: 1rem;"><a href="/#pricing" class="btn btn-primary" style="display: inline-block;">See pricing</a></p>
      </div>
    </section>

    <section class="radar-pro-section radar" id="radar-pro">
      <h2>Radar Pro</h2>
      <p class="radar-sub">Load your persisted reports. Set your API URL and upload token (from your Pro dashboard or env).</p>
      <div class="radar-actions">
        <input type="text" id="pro-api-url" placeholder="API URL (e.g. https://xxx.supabase.co/functions/v1)" style="max-width: 360px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text);" />
        <input type="text" id="pro-token" placeholder="Upload token" style="max-width: 280px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text);" />
        <button type="button" id="pro-load">Load my reports</button>
      </div>
      <div class="radar-pro-alerts" style="margin-top: 1rem;">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Alert webhook (optional)</h3>
        <p class="hint" style="margin-bottom: 0.5rem;">When a report exceeds thresholds, we POST to this URL. Set max outdated/vulns below (leave blank to only notify when &gt; 0).</p>
        <div class="radar-actions">
          <input type="text" id="pro-alert-webhook" placeholder="https://your-server.com/radar-webhook" style="max-width: 360px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text);" />
          <input type="number" id="pro-max-outdated" placeholder="Max outdated" min="0" style="width: 100px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text);" />
          <input type="number" id="pro-max-vulns" placeholder="Max vulns" min="0" style="width: 100px; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-soft); color: var(--text);" />
          <button type="button" id="pro-alert-save">Save alert settings</button>
        </div>
      </div>
      <div id="pro-list" class="radar-pro-list"></div>
    </section>

    <section class="radar-dashboard radar">
      <h2>Try Radar free</h2>
      <p class="radar-sub">Paste scan JSON below or upload a file. Use one report per line for multiple repos (NDJSON).</p>
      <div class="radar-actions">
        <button type="button" id="load" class="primary">Load report(s)</button>
        <button type="button" id="upload-btn">Upload file</button>
        <input type="file" id="file-input" accept=".json,application/json" />
        <button type="button" id="clear">Clear</button>
      </div>
      <textarea id="json" placeholder='Paste output of: upshift scan --report report.json&#10;Or: {"status":"ok","packageManager":"npm","outdated":[...],"cwd":"/path/to/repo",...}'></textarea>
      <p class="hint">Run <code>upshift scan --report report.json</code> in each repo, then paste the file contents here. For multiple repos, paste one JSON object per line.</p>

      <div id="summary" class="card-row" style="display: none;"></div>
      <div id="table-wrap"><p class="empty" id="empty-state">No reports yet. Paste JSON from <code>upshift scan --report report.json</code> or upload a file, then click <strong>Load report(s)</strong>.</p></div>

      <div class="cta-pro" id="cta-pro" style="display: none;">
        <p>Need persisted dashboards, history, and alerts?</p>
        <p><a href="/#pricing">Radar Pro</a> is included with Pro and Team. <a href="/#pricing">View pricing →</a></p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">
      <p><a href="/">upshift</a> · <a href="/radar/">Radar</a> · AI-powered dependency upgrades</p>
    </div>
  </footer>

  <script>
    const textarea = document.getElementById('json');
    const tableWrap = document.getElementById('table-wrap');
    const summaryEl = document.getElementById('summary');
    const ctaPro = document.getElementById('cta-pro');
    const loadBtn = document.getElementById('load');
    const clearBtn = document.getElementById('clear');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');

    function parseInput() {
      const raw = textarea.value.trim();
      if (!raw) return [];
      const reports = [];
      const lines = raw.split('\n').filter(l => l.trim());
      for (const line of lines) {
        try {
          const obj = JSON.parse(line);
          if (obj.outdated != null) reports.push(obj);
        } catch {}
      }
      // Single JSON object (no NDJSON): parse whole blob only if no lines succeeded
      if (reports.length === 0) {
        try {
          const single = JSON.parse(raw);
          if (single.outdated != null) reports.push(single);
        } catch {}
      }
      return reports;
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function rowsFromReports(reports) {
      return reports.map(r => ({
        repo: r.cwd || r.packageManager || 'unknown',
        ecosystem: r.ecosystem || r.packageManager || '—',
        outdated: Array.isArray(r.outdated) ? r.outdated.length : 0,
        vulns: r.vulnerabilities?.items?.length ?? 0,
      }));
    }

    const emptyStateHtml = '<p class="empty" id="empty-state">No reports yet. Paste JSON from <code>upshift scan --report report.json</code> or upload a file, then click <strong>Load report(s)</strong>.</p>';

    function renderFromReports(reports) {
      if (!reports || reports.length === 0) {
        summaryEl.style.display = 'none';
        ctaPro.style.display = 'none';
        tableWrap.innerHTML = '<p class="empty">No valid reports to display. Check that the JSON has <code>outdated</code> (array) and optionally <code>cwd</code>.</p>';
        return;
      }
      const rows = rowsFromReports(reports);
      const totalRepos = rows.length;
      const totalOutdated = rows.reduce((s, r) => s + r.outdated, 0);
      const totalVulns = rows.reduce((s, r) => s + r.vulns, 0);
      summaryEl.innerHTML =
        '<div class="radar-card"><span class="value">' + totalRepos + '</span><br><span class="label">Repos</span></div>' +
        '<div class="radar-card"><span class="value">' + totalOutdated + '</span><br><span class="label">Outdated</span></div>' +
        '<div class="radar-card"><span class="value">' + totalVulns + '</span><br><span class="label">Vulnerabilities</span></div>';
      summaryEl.style.display = 'flex';
      let html = '<table><thead><tr><th>Repo / path</th><th>Ecosystem</th><th class="count">Outdated</th><th class="count">Vulns</th></tr></thead><tbody>';
      for (const row of rows) {
        html += '<tr><td class="repo">' + escapeHtml(row.repo) + '</td><td>' + escapeHtml(row.ecosystem) + '</td><td class="count">' + row.outdated + '</td><td class="count">' + row.vulns + '</td></tr>';
      }
      html += '</tbody></table>';
      tableWrap.innerHTML = html;
      ctaPro.style.display = 'block';
    }

    function render() {
      const reports = parseInput();
      if (reports.length === 0) {
        summaryEl.style.display = 'none';
        ctaPro.style.display = 'none';
        tableWrap.innerHTML = emptyStateHtml;
        return;
      }
      renderFromReports(reports);
    }

    // Radar Pro: load persisted reports
    const proApiUrl = document.getElementById('pro-api-url');
    const proToken = document.getElementById('pro-token');
    const proLoadBtn = document.getElementById('pro-load');
    const proList = document.getElementById('pro-list');
    try {
      if (localStorage.getItem('radar_pro_api_url')) proApiUrl.value = localStorage.getItem('radar_pro_api_url');
      if (localStorage.getItem('radar_pro_token')) proToken.value = localStorage.getItem('radar_pro_token');
    } catch (e) {}
    proLoadBtn.addEventListener('click', async function() {
      const base = (proApiUrl.value || '').trim().replace(/\/$/, '');
      const token = (proToken.value || '').trim();
      if (!base || !token) {
        proList.innerHTML = '<p class="empty">Enter API URL and upload token, then click Load my reports.</p>';
        return;
      }
      try {
        localStorage.setItem('radar_pro_api_url', base);
        localStorage.setItem('radar_pro_token', token);
      } catch (e) {}
      proList.innerHTML = '<p class="hint">Loading…</p>';
      const res = await fetch(base + '/radar-reports?token=' + encodeURIComponent(token));
      if (!res.ok) {
        proList.innerHTML = '<p class="empty">Failed to load reports (' + res.status + '). Check URL and token.</p>';
        return;
      }
      const data = await res.json();
      const reports = data.reports || [];
      if (reports.length === 0) {
        proList.innerHTML = '<p class="empty">No reports yet. Upload with: <code>upshift scan --report out.json --upload</code></p>';
        return;
      }
      let html = '<table class="radar-pro-table"><thead><tr><th>Date</th><th>Name</th><th>Outdated</th><th>Vulns</th><th></th></tr></thead><tbody>';
      for (const r of reports) {
        const date = r.created_at ? new Date(r.created_at).toLocaleString() : '—';
        html += '<tr><td>' + escapeHtml(date) + '</td><td>' + escapeHtml(r.name || '—') + '</td><td class="count">' + (r.outdated_count ?? 0) + '</td><td class="count">' + (r.vuln_count ?? 0) + '</td><td><button type="button" class="pro-open" data-id="' + escapeHtml(r.id) + '">Open</button></td></tr>';
      }
      html += '</tbody></table>';
      proList.innerHTML = html;
      proList.querySelectorAll('.pro-open').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          const id = btn.getAttribute('data-id');
          const res2 = await fetch(base + '/radar-report?id=' + encodeURIComponent(id) + '&token=' + encodeURIComponent(token));
          if (!res2.ok) { tableWrap.innerHTML = '<p class="empty">Failed to load report.</p>'; return; }
          const data2 = await res2.json();
          if (data2.report) renderFromReports([data2.report]);
        });
      });
      // Load alert settings
      try {
        const alertRes = await fetch(base + '/radar-alert-settings', { headers: { 'X-Upload-Token': token } });
        if (alertRes.ok) {
          const alertData = await alertRes.json();
          document.getElementById('pro-alert-webhook').value = alertData.webhook_url || '';
          document.getElementById('pro-max-outdated').value = alertData.max_outdated != null ? alertData.max_outdated : '';
          document.getElementById('pro-max-vulns').value = alertData.max_vulns != null ? alertData.max_vulns : '';
        }
      } catch (e) {}
    });

    document.getElementById('pro-alert-save').addEventListener('click', async function() {
      const base = (proApiUrl.value || '').trim().replace(/\/$/, '');
      const token = (proToken.value || '').trim();
      if (!base || !token) { alert('Set API URL and upload token first.'); return; }
      const webhook = document.getElementById('pro-alert-webhook').value.trim();
      const maxOut = document.getElementById('pro-max-outdated').value;
      const maxVuln = document.getElementById('pro-max-vulns').value;
      const res = await fetch(base + '/radar-alert-settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Upload-Token': token },
        body: JSON.stringify({
          webhook_url: webhook || null,
          max_outdated: maxOut === '' ? null : parseInt(maxOut, 10),
          max_vulns: maxVuln === '' ? null : parseInt(maxVuln, 10)
        })
      });
      if (res.ok) alert('Alert settings saved.'); else alert('Failed to save: ' + (await res.text()));
    });

    loadBtn.addEventListener('click', render);
    clearBtn.addEventListener('click', function() {
      textarea.value = '';
      summaryEl.style.display = 'none';
      ctaPro.style.display = 'none';
      tableWrap.innerHTML = emptyStateHtml;
    });
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', function() {
      const f = this.files && this.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = function() {
        const content = r.result;
        if (textarea.value.trim()) textarea.value += '\n' + content;
        else textarea.value = content;
        fileInput.value = '';
      };
      r.readAsText(f);
    });
  </script>
</body>
</html>
